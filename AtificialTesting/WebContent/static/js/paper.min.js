OT2.Paper=function(){var e={1:"密封线",2:"大题评分区",3:"主标题",4:"注意事项",5:"副标题",6:"分卷",7:"考试时间",8:"分卷注释",9:"考生填写",10:"分大题",11:"总评分",12:"大题注释"},t={simple:{name:"简易模板",val:"3 10 12".split(/\s+/)},common:{name:"普通模板",val:"3 4 5 7 9 10 11 12".split(/\s+/)},normal:{name:"正式模板",val:"1 2 3 4 5 6 7 8 9 10 11 12".split(/\s+/)}},i={"单选题":{name:"单选题",order:1,part:1},"多选题":{name:"多选题",order:2,part:1},"判断题":{name:"判断题",order:3,part:1}},n=function(e,i){OT2.Event.call(this),i="undefined"==typeof i?{}:i,this.$el=$("#J_PaperLayout"),this.$body=$("#J_PaperBody"),this.editableInput=null,this.attributes={template:"simple",setting:_.clone(t.simple.val),title:"",subtitle:"",xd:"",xk:"",xdName:"",xkName:"",notes:"1、填写答题卡的内容用2B铅笔填写<br>2、提前 xx 分钟收取答题卡",paperPart:{1:{name:"第Ⅰ卷 客观题",tip:"第Ⅰ卷的注释"},2:{name:"第Ⅱ卷 主观题",tip:"第Ⅱ卷的注释"}},types:i,examtime:"* *",score:"* *",sheet:"1",expires:(new Date).getTime()},_.extend(this.attributes,e),this.paper_key=["paper2016",this.attributes.xd,this.attributes.xk].join(":"),this.pid=null,this.cacheObj={},this.verify=null,this.verify_code=null,this.verify_call=!1,this.basketQids=[]};return n.prototype={init:function(e,t){var i=this;return"undefined"!=typeof t&&t&&(_.each(e,function(e,t){i.cacheObj[e.id]={id:e.id,order:t+1,type:e.type,xd:e.xd,xk:e.xk}}),OT2.LocalData.set("basket_cacheObj_v2",JSON3.stringify(i.cacheObj))),this.unserialize(),"undefined"!=typeof e?(i.render(e),i):void this.fetchQuestionsDetail("/getQuestionsByCategory").done(function(e){i.render(e)})},render:function(e){this.renderBody(e),this.bindEvent(),this.renderPagerHeader(),this.renderSideSet(),this.renderSideTypes(),this.initNewSideTypeDrag(),this.initNewSideGridDrag(),this.intervalPublish("question:width",150),this.manual_events()},renderSideTypes_old:function(){var e=OT2.Util.Template().get("paper-types"),t=this.getList().length,i=[],n=this.getParts();n.sort(function(e,t){return e.id-t.id});for(var s,r=0;s=n[r++];){var a=s.getSections();a.sort(function(e,t){return e.order-t.order});for(var o,d=0;o=a[d++];){var c=o.getQuestions().length;i.push({type:o.type,size:c})}}var l=$(_.template(e,{self:this,size:t,data:i}));this.$sideTypes=$("#J_PaperTypes"),this.$sideTypes.empty().append(l);var e=OT2.Util.Template().get("paper-score"),u=$(_.template(e,{self:this}));$("#J_PaperScore").empty().append(u)},manual_events:function(){var e=this;this.$el.on("click",".toggle-sd-box",function(){var t=$(this).parent("h3").next("div"),i=!t.is(":visible");t[i?"show":"hide"](),this.innerHTML=i?"收起":"展开",e.autoHeightSideType()}),this.$sideTypes.on("click",".drag-grid",function(t){var i=$(this).attr("_qid");e.publish("question:scrolltoview",i)})},renderSideTypes:function(){var e=[],t=0,i=0,n=0,s={"容易":[0,1.7],"普通":[1.7,2.4],"困难":[2.4,1/0]},r=this.getParts().sort(function(e,t){return e.id-t.id});_.each(r,function(s,r){var a=s.getSections().sort(function(e,t){return e.order-t.order});_.each(a,function(s,r){var a=s.getQuestions().sort(function(e,t){return e.attributes.order-t.attributes.order}),o=s.type.substr(0,8);o=o.length>7?o+"...":o,e.push({type:s.type,short_type:o,_cid:s._cid,list:a}),_.each(a,function(e,s){i++,t+=e.attributes.score;var r=Number(e.model._difficult_index)||Number(e.model.difficult_index);3==r?r=2:5==r&&(r=3),n+=r||0})})}),i&&(n/=i,_.each(s,function(e,t){if(n>e[0]&&n<=e[1])return n=t,!1}));var a=OT2.Util.Template().get("paper-club"),o=$(_.template(a,{data:e,score:t,num:i,dd:n}));this.$sideTypes=$("#J_PaperTypes"),this.$sideTypes.html(o);var a=OT2.Util.Template().get("paper-score"),d=$(_.template(a,{self:this}));$("#J_PaperScore").empty().append(d)},getParts:function(){var e=[];return this.publish("part:sum",e),e},getList:function(){var e=[];return this.publish("question:list",this,e),e},initSideTypeDragSorting:function(){return!1},resortSections:function(){var e=this;e.$el.find(".paper-section").each(function(t){var i=$(this).attr("_cid");e.publish("section:manual:resorting",i,t)})},initNewSideTypeDrag:function(){var e=this;$doc=$(document);var t=!1,i=!1,n=null,s=null,r=null,a=null,o=100,d=!1,c=0,l=0,u=0,p=0,h=0,f=0,v=0,y="clone-drag-wire",b="drag-wire-dragging",g="sorting-section",m=function(e){if(i){t=!0,n.addClass(b);var o=e.clientX-c,p=e.clientY-l;s.offset({left:u,top:p}),a=null,r.each(function(){var e=$(this),t=this._offset,i=t.top,s=t.left,r=e.height(),c=e.width(),l=o>s+c||p>i+r||o+f<s||p+v<i;if(!l){a=this,d=p>h,h=p;var u=d?"insertAfter":"insertBefore";return n[u](a),!1}})}};this.$sideTypes.on("mousedown","div.drag-wire",function(e){$("html,body").stop(),i=!0;var t=$(e.target);if((t.hasClass("t-del")||t.hasClass("t-order")||t.hasClass("drag-grid"))&&(i=!1),n=$(this),r=n.siblings(),0==r.length&&(i=!1),!i)return!1;r.each(function(){this._offset=$(this).offset()}),f=n.width(),v=n.height(),s=n.clone(),s.attr("id",y),s.css({position:"absolute",width:f,height:v,"z-index":o++});var a=n.offset();u=a.left,p=a.top,l=e.clientY-p,c=e.clientX-u,h=p,s.offset({left:u,top:p}),$("#"+y).length<1&&n.parent().append(s)}),$doc.on("mousemove",_.throttle(m,50)),$doc.on("mouseup",function(o){if(i&&t&&a){var c=d?"insertAfter":"insertBefore",l=n.data("typename"),u=$(a).data("typename"),p=e.getSectionByType(l),h=e.getSectionByType(u);p.part=h.part,e.attributes.types[l].part=h.part.id,p.$el[c](h.$el),p.$el.addClass(g),p.scrolltoView(),e.resortSections(),e.initQuestionListSort(),e.renderSideTypes(),e.serialize()}i&&(n&&n.removeClass(b),s&&s.remove(),s=null,t=!1,i=!1,n=null,r=null,a=null)})},initNewSideGridDrag:function(){var e=this,t=$(document),i=!1,n=!1,s=null,r=null,a=null,o=null,d=0,c=0,l=0,u=0,p=!1,h=0,f=500,v="grid-dragging",y=0,b=0,g=function(e){if(n){i=!0,o.addClass(v);var t=e.clientX-d,l=e.clientY-c;s.offset({left:t,top:l}),a=null,r.each(function(){var e=$(this),i=this._offset,n=i.left,s=i.top,r=e.width(),d=e.height(),c=t>n+r||l>s+d||t+y<n||l+b<s;if(!c)return p=t<h,h=t,a=this,o[p?"insertBefore":"insertAfter"](a),!1})}};this.$sideTypes.on("mousedown",".drag-grid",function(e){if($("html,body").stop(),e.stopPropagation(),n=!0,o=$(this),r=o.siblings(),0==r.length&&(n=!1),!n)return!1;r.each(function(){this._offset=$(this).offset()}),y=o.width(),b=o.height(),s=o.clone(),s.attr("id","clone-drag-grid"),s.css({position:"absolute",width:y,height:b,"z-index":f++});var t=o.offset();l=t.left,u=t.top,d=e.clientX-l,c=e.clientY-u,h=l,s.offset({left:l,top:u}),$("#clone-drag-grid").length<1&&o.parent().append(s)}),t.on("mousemove",_.throttle(g,50)),t.on("mouseup",function(t){if(n&&i){var d=o.parent().find(".drag-grid");d.each(function(t){if("clone-drag-grid"==this.id)return!0;var i=$(this).attr("_qid");e.publish("question:setorder","question-"+i,t)}),e.publish("paper:questionlist:sort"),e.renderSideTypes(),e.publish("question:scrolltoview",o.attr("_qid")),e.serialize()}n&&(o&&o.removeClass(v),r&&r.removeClass("grid-crash"),s&&s.remove(),i=!1,n=!1,s=null,o=null,r=null,a=null)})},resortSideGrids:function(){},getSectionByType:function(e){var t=null,i=this.getParts();return _.each(i,function(i){var n=i.getSections();_.each(n,function(i){if(e==i.type)return t=i,!1})}),t},getSectionByCid:function(e){var t=null;return _.each(this.getParts,function(i){_.each(i.getSections,function(i){if(e===i._cid)return t=i,!1})}),t},getPartById:function(e){var t=this.getParts();return _.find(t,function(t){return t.id==e})},getAllSection:function(){var e=[],t=this.getParts();return _.each(t,function(t){e=e.concat(t.getSections())}),e},renderBody:function(e){var t=this,n={};_.each(e,function(e){if(e&&e.id&&_.contains(t.basketQids,e.id)){var i=t.cacheObj[e.id]||{},s=i.type||e.type;n[e.id]={model:e,attr:i,type:s}}});var s=_.sortBy(t.cacheObj,"order");_.each(s,function(e){if(e.new_model&&e.xd==t.attributes.xd&&e.xk==t.attributes.xk){var i=e||{},s=i.type||e.new_model.type;n[e.id]={model:e.new_model,attr:i,type:s}}}),uuu=$.extend(!0,{},n),n=_.sortBy(n,function(e){return e.attr.order-0});var r=_.uniq(_.map(n,function(e){return e.type})),a={},o=0;_.each(r,function(e,t){var n=2;i[e]?a[e]=$.extend({},i[e],{order:o++}):a[e]={name:e,order:o++,part:n}}),t.attributes.types=$.extend({},a,t.attributes.types),t.serialize();t.$body.empty();var d=0;_.map(t.attributes.paperPart,function(e,i){var n={id:i,name:e.name,tip:e.tip,order:d++};new OT2.Paper.Part(t,n).init()});var c=t.getParts();c=_.sortBy(c,"order");var l=0,u=_.sortBy(t.attributes.types,"order");_.each(c,function(e){_.each(u,function(i,s){var r=i.name;if(e.id==i.part){var a={order:l,type:r};t.attributes.types[r].order=l;var o=new OT2.Paper.Section(t,e,a);o.init(),_.chain(n).sortBy(function(e){return e.attr.sort-0}).each(function(e,i){if(e.type==r){var n=new OT2.Paper.Question(t,o,e.model,e.attr);o.$body.append(n.$el)}}),e.$el.append(o.$el),l++}}),t.$body.append(e.$el)}),t.initQuestionListSort(),t.serialize()},initQuestionListSort:function(){var e=this;e.subscribe("paper:questionlist:sort",function(){var t=e.getAllSection();t=_.sortBy(t,"order");var i=0;_.each(t,function(e){e.initQuestionSort(i),i+=e.getQuestions().length})}),e.publish("paper:questionlist:sort")},renderPagerHeader:function(){var e=this;this.$el.find(".contenteditable").each(function(){var t=$(this).data("edit");_.contains(["title","subtitle","examtime","score","notes"],t)&&$(this).html(e.attributes[t])})},fetchQuestionsDetail:function(e){var t=this,i=$.Deferred();return $.post(e,{list:t.basketQids},"json").done(function(e){i.resolve(e)}),i.promise()},serialize:function(){this.pid&&(this.pid=null),OT2.LocalData.set(this.paper_key,JSON3.stringify(this.attributes)),OT2.LocalData.set("basket_cacheObj_v2",JSON3.stringify(this.cacheObj))},unserialize:function(){var e=null;try{e=JSON3.parse(OT2.LocalData.get(this.paper_key))}catch(t){}var i=(new Date).getTime();e&&(i-=e.expires,0==e.expires?this.attributes=e||this.attributes:i<6048e5&&(e.expires=(new Date).getTime(),this.attributes=e||this.attributes));var n={};try{n=JSON3.parse(OT2.LocalData.get("basket_cacheObj_v2"))}catch(t){}this.cacheObj=n||{},this.getPaperBasketQids()},stringify:function(){var e=this,t={content:[],title:e.attributes.title,subtitle:e.attributes.subtitle,xd:e.attributes.xd,chid:e.attributes.xk,notes:e.attributes.notes,examtime:"考试时间："+e.attributes.examtime+"&nbsp;分钟&nbsp;&nbsp;&nbsp;&nbsp;满分："+e.attributes.score+"&nbsp;分",paperPart:e.attributes.paperPart,setting:e.attributes.setting},i={};try{i=JSON3.parse(OT2.LocalData.get("basket_cacheObj_v2"))||{}}catch(n){}var i=_.sortBy(i,"order"),s=_.sortBy(e.attributes.types,"order");return _.each(s,function(n,s){var r={head_title:n.name,questions:[],scores:{}};_.each(i,function(t,i){if(t.type==n.name&&t.xd==e.attributes.xd&&t.xk==e.attributes.xk){r.questions.push(t.id);var s={score:"4"};"undefined"!=typeof t.subScore&&(s.subScore=t.subScore),"undefined"!=typeof t.score&&(s.score=t.score),r.scores[t.id]=s}}),t.content.push(r)}),t},getPaperBasketQids:function(){var e=this;return e.basketQids=[],_.each(e.cacheObj,function(t,i){e.basketQids.push(t.id)}),e.basketQids},getSetting:function(){return e},getPaperSet:function(){return t},renderSideSet:function(){var e=this,t=OT2.Util.Template().get("paper-template"),i={setting:this.getSetting(),paperset:this.getPaperSet(),attr:this.attributes};this.$set=$(_.template(t,i)),$("#J_PaperSetRadio").empty().append(this.$set),t=OT2.Util.Template().get("paper-setoptions"),this.$setopt=$(_.template(t,i)),$("#J_PaperSetCheck").empty().append(this.$setopt);var n=[],s=[];this.$set.find(".radiobox").each(function(){new OT2.Element.radio(this,n).bindEvent(function(){e.attributes.template=this.$input.val(),e.publish("paper:template",this.$input.val())})}),this.$setopt.find(".checkbox").each(function(){var t=new OT2.Element.checkbox(this,s);t.bindEvent(function(){e.publish("paper:setting",this.checked,this.$input.val()),1==this.$input.val()&&e.publish("question:width")}),e.publish("paper:setting",t.checked,t.$input.val()),e.subscribe("paper:template",function(i){var n=e.getPaperSet()[i].val,s=t.$input.val(),r=!1;_.contains(n,s)&&(r=!0),t.switchChecked(r,function(){e.publish("paper:setting",this.checked,this.$input.val())})})})},bindEvent:function(){var e=this;this.bindContentEditArea(),this.bindPaperSetting(),this.subscribe("question:destroy",function(t){e.destroyQuestionById(t.model.id,t),e.publish("paper:questionlist:sort"),e.renderSideTypes()}),this.subscribe("question:destroyBatch",function(t){e.destroyQuestionById(t.model.id,t),e.renderSideTypes()}),this.subscribe("question:replace",function(t,i){e.replaceQuestion(t,i)}),this.subscribe("question:transfer:renderSideType",function(t,i){e.cacheObj[t].type=i,e.serialize(),e.renderSideTypes()}),$(document).on("keyup",function(t){13==t.keyCode&&e.editableInput&&e.editableInput.is("input")&&e.editableInput.blur()}),$(window).on("scroll",_.throttle(function(){e.fixedSide()},100)),$(window).on("resize",_.debounce(function(){e.autoHeightSideType()},100))},replaceQuestion:function(e,t){var i=this;delete t.model.q,i.cacheObj[t.attributes.id]=$.extend(!0,{},t.attributes,{new_model:t.model}),delete i.cacheObj[e.attributes.id],e.paper=null,e.section=null,e=null,i.publish("question:width"),i.serialize()},deleteQuestions:function(e){var t=this,i=dialog({title:"友情提示",content:'你确定要删除"'+e+'"吗?',padding:20,okValue:"确定",cancelValue:"取消",ok:function(){t.doDeleteQuestions(e)},cancel:function(){this.close()}});i.showModal()},doDeleteQuestions:function(e){this.publish("question:deleteBatch",e),delete this.attributes.types[e],this.publish("paper:questionlist:sort"),this.serialize(),this.renderSideTypes()},renderSideOrder:function(e){var t=[],i=this.getParts().sort(function(e,t){return e.id-t.id});_.each(i,function(e,i){var n=e.getSections().sort(function(e,t){return e.order-t.order});_.each(n,function(e,i){var n=e.type.substr(0,8);n=n.length>7?n+"...":n,t.push({_cid:e._cid,type:e.type,short_type:n})})});var n=$(_.template(OT2.Util.Template().get("club-sort"),{data:t,_cid:e})),s=[],r=[];return n.find(".custom-checkbox").each(function(){new OT2.Element.checkbox(this,s).bindEvent()}),n.find(".custom-radio").each(function(){new OT2.Element.radio(this,r).bindEvent()}),n},askOrder:function(e){var t=this,i=this.renderSideOrder(e),n=dialog({title:"试题排序",content:i,okValue:"确定",cancelValue:"取消",width:600,ok:function(){var e=i.find("form").serializeArray(),n=[],s=1;_.each(e,function(e,t){"type[]"===e.name&&n.push(e.value),"orderby"===e.name&&(s=e.value)}),t.multi_resort_questions(n,s)},cancel:function(){this.remove()}});n.showModal()},multi_resort_questions:function(e,t){var i=this,n=_.sortBy(i.getAllSection(),"order"),s=0,r=function(e,i){var n=Number(e.model._difficult_index-i.model._difficult_index)||0;return n*=t,0==n&&(n=Number(i.model.question_id-e.model.question_id)||0),n};_.each(n,function(t){_.contains(e,t._cid)&&t.initQuestionSort(s,r),s+=t.getQuestions().length}),i.serialize(),i.renderSideTypes()},bindPaperSetting:function(){var e=this;this.subscribe("paper:setting",function(t,i){e.$el.find("[data-paperset]").each(function(){i==$(this).data("paperset")&&$(this)[t?"show":"hide"]()}),e.attributes.setting=_.uniq(e.attributes.setting),t?e.attributes.setting.push(i):e.attributes.setting=_.reject(e.attributes.setting,function(e){return e==i})})},bindContentEditArea:function(){this.listenContenteditable();var e=this;this.$el.on("click",".contenteditable",function(){var t=this,i=$(this).data("edit");if("undefined"==typeof this._input){"notes"==i?this._input=$("<textarea>"):this._input=$("<input>"),this._input.insertAfter(this);var n=this.innerHTML;this._input.on("blur",function(){n=$(this).data("oldvalue")||n,$(t).show(),$(this).hide();var s=$.trim(this.value);return!!s&&("notes"==i&&(this.value=s.replace(/\n/g,"<BR>")),$(t).html(this.value),$(this).data("oldvalue",this.value),e.publish("paper:contenteditable",i,this.value,t,n),void(e.editableInput=null))})}e.editableInput=this._input,this._input.show(),this._input.focus();var s=this.innerHTML;"notes"==i&&(s=s.replace(/<br>|<BR>/g,"\n")),this._input.val(s),$(this).hide()})},listenContenteditable:function(){var e=this;this.subscribe("paper:contenteditable",function(t,i,n,s){if(_.contains(["title","subtitle","examtime","score","notes"],t))e.attributes[t]=i;else if("paperPart.name"==t||"paperPart.tip"==t){var r=$(n).data("part"),a="tip";"paperPart.name"==t&&(a="name"),e.attributes.paperPart[r][a]=i}else"type"==t&&(e.publish("question:changeType",i,s),e.attributes.types[i]=$.extend({},e.attributes.types[s]),e.attributes.types[i].name=i,delete e.attributes.types[s],e.renderSideTypes());e.serialize()})},addNewType:function(){var e=this,t=$(_.template(OT2.Util.Template().get("add-type"),{})),i=t.find("input"),n=t.find(".error-msg"),s=dialog({title:"添加自定义题型",content:t.get(0),okValue:"确定",ok:function(){var t=$.trim(i.val()),r="";return t.length<=0?r="题型名称不能为空！":(t.length>10||t.length<3)&&(r="题型名称3-10个字符！"),n[r?"show":"hide"](),n.html(r),!r&&(e.insertNewType(t),void s.close())},fixed:!0,cancelValue:"取消",cancel:function(){}});s.showModal()},insertNewType:function(e){var t=this;if(t.attributes.types[e])return!1;var i=_.size(t.attributes.types);t.attributes.types[e]={name:e,order:i,part:2},t.serialize();var n=t.getPartById(2),s={type:e,order:i},r=new OT2.Paper.Section(t,n,s);r.init(),n.$el.append(r.$el),t.renderSideTypes(),r.scrolltoView()},destroyQuestionById:function(e,t){var i=this;delete i.cacheObj[e],"undefined"!=typeof t&&(t.paper=null,t.section=null,t=null),i.serialize()},checkVerify:function(){var e=this,t=$("input[name=verifycode]").val();return""==t?(OT2.Util.alert("请输入验证码"),!1):(e.verify_code=t,void e.verify_call())},check_err:function(e){var t=this;t.pid||t.verify||t.verify_code||($.ajaxSettings.async=!1,$.getJSON("/paper/check-verify",{},function(i){$.ajaxSettings.async=!0,403==i.errCode?(t.verify=!0,OT2.Util.verify(e)):t.verify=!1}))},save:function(){var e=this;return e.check_err(e.save),!(e.verify&&!e.verify_code)&&void e.saveProcess(function(){var t=(e.pid,OT2.Util.Template().get("dialog-save")),i=$(_.template(t,{pid:e.pid}));i.find("a").click(function(){return window.location.replace(this.href),!1});var n=dialog({title:"提示",content:i.get(0),fixed:!0});n.showModal(),i.find("#b-download").click(function(){e.download(),n.close()}),i.find("#b-share").click(function(){e.shareDialog(),n.close()})})},refreshCaptcha:function(){$.get("/site/captcha",{refresh:1},function(e){$("#zujuan-captcha").attr("src",e.url)})},saveProcess:function(e){var t=this;if(t.pid)return e(),!1;var i=this.stringify();i.pid=t.pid,t.verify_code&&(i.verifyCode=t.verify_code),$.post("/paper/create",i,function(i){if(0==i.errCode){t.verify=!1,t.verify_code=null,dialog({id:"checkform"}).close(),t.pid=i.data.pid,OT2.LocalData.remove(t.paper_key);var n={};try{n=JSON3.parse(OT2.LocalData.get("basket_cacheObj_v2")),_.each(n,function(e,i){e.xd==t.attributes.xd&&e.xk==t.attributes.xk&&delete n[i]})}catch(s){}OT2.LocalData.set("basket_cacheObj_v2",JSON3.stringify(n)),e()}else 400==i.errCode?(t.refreshCaptcha(),t.verify_code=null,t.verify=null,OT2.Util.alert("图形验证码错误,请重新填写")):OT2.Util.alert(i.message)},"json")},adminSave:function(e,t){var i=this;i.pid=e;var n=this.stringify();$.post("/paper/admin-create?pid="+i.pid+"&type="+t,n,function(e){0==e.errCode?(i.pid=e.data.pid,OT2.LocalData.remove(i.paper_key),OT2.LocalData.remove("basket_cacheObj_v2"),OT2.LocalData.remove("basket_cachePid"),OT2.Util.alert("试卷保存成功"),window.location.replace("/paper/view/"+i.pid)):OT2.Util.alert("试题保存失败,请检查试卷排版")},"json")},download:function(e){var t=this;return t.check_err(t.download),!(t.verify&&!t.verify_code)&&("undefined"!=typeof e&&(t.pid=e),"undefined"==typeof USER.uid?(OT2.Global.initLogin(),!1):void t.saveProcess(function(){var e;$.ajax({url:"/paper/download-params",data:{pid:t.pid},dataType:"json",async:!1,success:function(t){e=t.data}});var i={chooseType:"student",chooseSize:"A4",renderMathAsImg:1,chooseContent:["an"]},n="下载",s=function(){OT2.Util.alert("生成试卷,请耐心等待"),window.location="/paper/download?pid="+t.pid+"&size="+i.chooseSize+"&type="+i.chooseType+"&content_type="+i.chooseContent+"&renderMathAsImg="+i.renderMathAsImg};e.isCan||(n="充值学币",DDDD=function(){window.location.replace("http://www.21cnjy.com/pay/")});var r=[],a=[],o=[],d=e.view,c=$(_.template(d,{}));c.find(".download-size .radiobox").each(function(){new OT2.Element.radio(this,r).bindEvent(function(){i.chooseSize=this.$input.val()})}),c.find(".download-type .radiobox").each(function(){new OT2.Element.radio(this,a).bindEvent(function(){i.chooseType=this.$input.val()})}),c.find(".download-math .radiobox").each(function(){new OT2.Element.radio(this,o).bindEvent(function(){i.renderMathAsImg=this.$input.val()})}),c.find(".download-type .checkbox").click(function(){var e=$(this).find("input").val();$(this).hasClass("checked")?(i.chooseContent.splice($.inArray(e,i.chooseContent),1),$(this).removeClass("checked"),$(this).find("input").removeAttr("checked")):(i.chooseContent.push(e),$(this).addClass("checked"),$(this).find("input").attr("checked",""))}),c.find("button.recharge-btn").on("click",function(){p.close(),s()});var l=function(){$.get("/payment/check-order",{pid:t.pid,username:USER.username},function(e){"success"==e&&(c.find(".down_btn .recharge-btn").first().trigger("click"),"undefined"!=typeof u&&clearInterval(u))})};if(!e.isCan)var u=setInterval(l,1e3);var p=dialog({title:"下载word试卷",content:c,width:450,onclose:function(){"undefined"!=typeof u&&(clearInterval(u),u=null)}});p.showModal()}))},showPie:function(e){var t=this;if("undefined"!=typeof e&&(t.pid=e),t.pid)OT2.PaperAnalysis.show("/paper/pie/"+t.pid);else if(!t.pid){var i={},n=JSON3.parse(OT2.LocalData.get("basket_cacheObj_v2")),s=this.stringify();_.each(n,function(e,t){i[e.id]=e.id}),$.post("/paper/pie",{qids:i,content:s.content},function(e){0==e.errCode&&OT2.PaperAnalysis.show1(e.data)})}},shareDialog:function(e){var t=this;"undefined"!=typeof e?t.pid=e:t.pid||OT2.Util.alert("请先保存试卷");var i={title:t.attributes.title},n="";if($.ajax({url:"/paper/share-info",data:{pid:t.pid},dataType:"json",async:!1,success:function(e){i=e.data,0!=e.errCode&&(n=e.message)}}),""!==n)return void OT2.Util.alert(n);i.pid=t.pid;var s=OT2.Util.Template().get("dialog-share"),r=$(_.template(s,i)),a=dialog({title:"试卷共享编辑",content:r.get(0),okValue:"确定",cancelValue:"取消",ok:function(){var e=r.find("#share-form").serializeArray();$.post("/paper/share",e,function(e){0==e.errCode?OT2.Util.alert("试卷分享成功"):OT2.Util.alert(e.message)},"json"),a.close()},cancel:function(){}});a.showModal()},collectPaper:function(e,t){var i=this;"undefined"!=typeof e?i.pid=e:i.pid||OT2.Util.alert("请先保存试卷"),$.get("/paper/collect",{pid:i.pid},function(e){0==e.errCode?(OT2.Util.alert(e.message),t("收藏成功"==e.message)):OT2.Util.alert(e.message)})},setAnswerSheet:function(e){var t=this;return t.check_err(t.setAnswerSheet),!(t.verify&&!t.verify_code)&&("undefined"!=typeof e&&(t.pid=e),!t.pid,void t.saveProcess(function(){var e=t.attributes.sheet,i=OT2.Util.Template().get("dialog-answer-sheet"),n=$(_.template(i,{self:t}));n.vmenu=n.find(".menu"),n.vsheetlist=n.find(".sheet-list"),n.vtit=n.find(".s-title"),n.vsheets=n.find(".sheet div"),n.vmenu.on("click",function(){n.vsheetlist.show(),$(this).addClass("active")}),n.vsheetlist.find("li").on("click",function(t){t.stopPropagation(),n.vsheetlist.hide(),n.vtit.html(this.innerHTML),e=$(this).data("sheet"),n.vsheets.hide(),n.vsheets.eq(e-1).show(),n.vmenu.removeClass("active")}),$(document).on("click",function(e){0!=$(e.target).parents(".menu").length||$(e.target).hasClass("menu")||(n.vsheetlist.hide(),n.vmenu.removeClass("active"))}),n.vsheetlist.find('li[data-sheet="'+e+'"]').click();var s=dialog({title:"下载答题卡",content:n.get(0),okValue:"确定",cancelValue:"取消",ok:function(){var i={1:"c",2:"a",3:"b"};t.attributes.sheet=e,OT2.Util.alert("生成试卷答题卡中,请耐心等待"),window.location="/paper/download-answer-sheet?pid="+t.pid+"&size="+i[e],t.serialize()},cancel:function(){}});s.showModal()}))},fixedSide:function(){var e=document.body.scrollTop||document.documentElement.scrollTop;this.isFixedSide=e>110,this.$el[this.isFixedSide?"addClass":"removeClass"]("fixed"),this.autoHeightSideType()},autoHeightSideType:function(){var e=document.documentElement.clientHeight;"undefined"==typeof this.sideTypes_Height&&(this.sideTypes_Height=this.$sideTypes.height());var t=$("#sd-set-wire"),i=t.height();t.is(":visible")||(i=0),e=this.isFixedSide?e-i-190-56:e-i-300-56,this.sideTypes_Height<e?(this.$sideTypes.css({height:"auto"}),this.$sideTypes.removeClass("overflow")):(this.$sideTypes.css({height:e}),this.$sideTypes.addClass("overflow"))}},_.extend(n.prototype,OT2.Event.prototype),n}();