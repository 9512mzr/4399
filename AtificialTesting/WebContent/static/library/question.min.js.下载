OT2.Basket=function(){function e(i){if(!(this instanceof e))return new e(i);OT2.Event.call(this),this.el=i||document.createElement("div"),this.$el=$(this.el),this.$list=this.$el.find(".basket-count"),this.isVisible=this.$el.hasClass("active"),this.activeClass="active",this.model=[],this.cacheObj={},this.unserialize(),this.render(),this.bindEvent(),this.wireIframe=OT2.Wireiframe()}var i=_.template(OT2.Util.Template().get("basketList"));return e.prototype={changeVisual:function(){this.isVisible=!this.isVisible,this.$el[this.isVisible?"addClass":"removeClass"](this.activeClass)},bindEvent:function(){var e=this;this.$el.find(".basket-tit").on("click",function(){e.changeVisual()}),e.subscribe("Question:add",function(i){if(e.unserialize(),_.contains(e.model,i.id))return!1;e.model.push(i.id);var t=_.pluck(e.cacheObj,"order"),s=_.size(t)?Number(_.max(t)):0;e.cacheObj[i.id]={id:i.id,type:i.type,xd:i.xd,xk:i.xk,order:s+1},e.serialize()}),e.subscribe("Question:move",function(i){e.wireIframe.move(i,e)}),e.subscribe("Question:remove",function(i){e.unserialize(),e.model=_.without(e.model,i.id),e.cacheObj[i.id]&&delete e.cacheObj[i.id],e.serialize()})},getPosition:function(){var e=this.$el.offset(),i=this.$el.width();this.$el.height();return{left:e.left+i,top:e.top}},serialize:function(){OT2.LocalData.set("basket_cacheObj_v2",JSON3.stringify(this.cacheObj)),this.render()},unserialize:function(){this.cacheObj={};try{this.cacheObj=JSON3.parse(OT2.LocalData.get("basket_cacheObj_v2"))||{}}catch(e){}this.model=[],this.model=_.chain(this.cacheObj).sortBy("order").map(function(e){return e.id}).value()},render_old:function(){this.$list.empty();for(var e,t={},s=0,a=0;e=this.model[a++];){var n=this.cacheObj[e];if(n&&(void 0===OT2.xd_chid||n.xk==OT2.xd_chid.chid&&n.xd==OT2.xd_chid.xd)){var d=n.type;void 0===t[d]?t[d]=[e]:t[d].push(e),s++}}var o=_.map(t,function(e,i){return{key:i,val:e,id:1e3}});if("undefined"!=typeof PARAMS&&PARAMS.question_types){var l=_.invert(PARAMS.question_types);o=(o=_.map(t,function(e,i){return{key:i,val:e,id:l[i]?Number(l[i]):1e3}})).sort(function(e,i){return e.id-i.id})}this.$list.append(i({num:s,list:o}))},render:function(){for(var e,t=[],s=0,a=0;e=this.model[a++];){var n=this.cacheObj[e];n&&((void 0===OT2.xd_chid||n.xk==OT2.xd_chid.chid&&n.xd==OT2.xd_chid.xd)&&(t.push(n),s++))}try{t=_.sortBy(t,"order2");var d=_.uniq(_.pluck(t,"type")),o=_.groupBy(t,"type"),l=_.map(d,function(e){return{key:e,val:_.pluck(o[e],"id")}})}catch(e){t=_.sortBy(t,"order");l=_.map(PARAMS.sortQuestionTypes,function(e){var i=e.name;return{key:i,val:_.chain(t).filter(function(e){return e.type==i}).pluck("id").value()}});l=_.filter(l,function(e){return _.size(e.val)})}this.$list.html(i({num:s,list:l}))},getLenght:function(e){var i=0;for(var t in e)i++;return i},removeAll:function(e){var i=this,t=[].slice.call(arguments,1);dialog({title:"友情提示",content:'你确定要删除"'+e+'"吗?',padding:20,okValue:"确定",cancelValue:"取消",ok:function(){_ids=_.map(t,function(e){return e+""}),i.model=_.difference(i.model,t),i.model=_.difference(i.model,_ids);for(var s,a=0;s=t[a++];)i.publish("remove:byid",s),delete i.cacheObj[s];i.deleteQtypeWithXdXk(e),i.serialize()},cancel:function(){this.close()}}).showModal()},addAll:function(e){this.unserialize();for(var i,t=_.pluck(this.cacheObj,"order"),s=_.size(t)?Number(_.max(t)):0,a=0;i=e[a++];)if(!_.contains(this.model,i.model.id)){if(void 0!==OT2.xd_chid)n=_.filter(this.cacheObj,function(e){return e.xk==OT2.xd_chid.chid&&e.xd==OT2.xd_chid.xd}).length;else var n=this.model.length;if(void 0===USER.basketLimit&&(USER.basketLimit=30),n>=USER.basketLimit){var d="抱歉，您的试题篮最多可选"+USER.basketLimit+"道试题";USER.isVip||0!=USER.school_permit_id||(d+='</br><span style="color:#666666;font-size:12px">vip用户可选50道试题，<a href="/payment/vip" target="_blank" class="notice-pjq">开通vip</a><span>'),OT2.Util.alert(d,1);break}this.publish("add:byid",i.model.id),this.cacheObj[i.model.id]={id:i.model.id,type:i.model.type,xd:i.model.xd,xk:i.model.xk,order:s+1}}this.model=_.chain(this.cacheObj).sortBy("order").map(function(e){return e.id}).value(),this.serialize()},deleteQtypeWithXdXk:function(e){i="";if(void 0!==OT2.xd_chid){var i=["paper2016",OT2.xd_chid.xd,OT2.xd_chid.chid].join(":"),t=OT2.LocalData.get(i);if(!t||0==t.length)return!1;var s={};try{s=JSON3.parse(t)||{}}catch(e){}void 0!==s.types&&void 0!==s.types[e]&&(delete s.types[e],OT2.LocalData.set(i,JSON3.stringify(s)))}}},_.extend(e.prototype,OT2.Event.prototype),e}(),OT2.Wireiframe=function(){var e=null;return function(){return e||(e={$el:$("<div>"),init:function(){this.$el.css({position:"absolute",display:"none"}),this.$el.appendTo(document.body)},move:function(e,i){var t=e.$el,s=t.position(),a=t.width(),n=t.height();this.$el.css({width:a,height:n,left:s.left,top:s.top,opacity:1}),this.$el.show();var d=i.getPosition();d.width=0,d.height=0,this.$el.append(t.clone(!1));var o=Math.abs(d.left-s.left),l=Math.abs(d.top-s.top),h=Math.sqrt(o*o+l*l)/2.5;this.$el.animate(d,h,function(){$(this).empty(),$(this).hide()})}}),e.init(),e}}(),OT2.Question=function(){var e=_.template(OT2.Util.Template().get("question-item")),i=_.template(OT2.Util.Template().get("exam-point")),t=_.template(OT2.Util.Template().get("exam-answer")),s=_.template(OT2.Util.Template().get("exam-explanation")),a=(_.template(OT2.Util.Template().get("exan-temp")),function(e,i){this.basket=i,this.model={added:!1},void 0!==e.added&&(this.model.added=e.added),_.extend(this.model,e),this.$el=null,this.$addBtn=null,this.visibled_analyticbox=!1,this.rendered_analyticbox=!1});return a.prototype={render:function(i){var t=this;if(i)this.$el=i,this.basket.subscribe("question:width",function(){t.$el.find(".exam-s").each(function(){OT2.Util.calcItemWidth($(this))})});else{var s=$(e(this.model)),a=new OT2.QuestionTxt(this.model,this.basket);a.render(),s.find(".exam-head").after(a.$el),this.$el=s}return this.cacheElements(),this.bindEvent(),this},show_analyticbox:function(){var e="undefined"==typeof USER?{uid:null}:USER;if(!1===this.rendered_analyticbox&&!0===this.visibled_analyticbox){this.rendered_analyticbox=!0,this.$el.find(".exam-foot").before('<div class="analyticbox-brick"></div>');var a=i({q:this.model,user:e});this.$el.find(".analyticbox-brick").append(a),"7"==this.model.question_type?(a=_.map(this.model.list,function(i,s){return t({q:i,user:e})}),this.$el.find(".exam-qlist > .exam-con").each(function(e,i){$(this).after(a[e])})):(this.$el.find(".analyticbox-brick").addClass("analyticbox-brick-normal"),a=t({q:this.model,user:e}),this.$el.find(".analyticbox-brick").append(a)),a=s({q:this.model,user:e}),this.$el.find(".analyticbox-brick").append(a),this.$el.addClass(this.model.explanation?"beauty-man":"uglify-man")}this.$el[this.visibled_analyticbox?"addClass":"removeClass"]("visible-ake"),this.$el.find(".analyticbox, .analyticbox-brick")[this.visibled_analyticbox?"show":"hide"]()},cacheElements:function(){this.$addBtn=this.$el.find(".J_AddQuestion")},addToBasket:function(){this.model.added=!0,this.$addBtn.html("<b>-</b>移除"),this.$addBtn.addClass("removebtn"),this.$addBtn.removeClass("addbtn")},removeFromBasket:function(){this.model.added=!1,this.$addBtn.html("<b>+</b>选题"),this.$addBtn.removeClass("removebtn"),this.$addBtn.addClass("addbtn")},addOrRemove:function(e){if(!this.model.added||e&&void 0!==e){var i=this.countQnumsByChid();if(void 0===USER.basketLimit&&(USER.basketLimit=30),i>=USER.basketLimit){var t="抱歉，您的试题篮最多可选"+USER.basketLimit+"道试题";return USER.isVip||0!=USER.school_permit_id||(t+='</br><span style="color:#666666;font-size:12px">vip用户可选50道试题，<a href="/payment/vip" target="_blank" class="notice-pjq">开通vip</a><span>'),OT2.Util.alert(t,1),!1}this.addToBasket(),this.basket.publish("Question:add",this.model),this.basket.publish("Question:move",this)}else this.removeFromBasket(),this.basket.publish("Question:remove",this.model)},countQnumsByChid:function(){return void 0!==OT2.xd_chid?_.filter(this.basket.cacheObj,function(e){return e.xk==OT2.xd_chid.chid&&e.xd==OT2.xd_chid.xd}).length:this.basket.model.length},bindEvent:function(){var e=this;this.$addBtn.on("click",function(){if(void 0===USER.uid)return OT2.Global.initLogin();e.addOrRemove()}),this.basket.subscribe("remove:byid",function(i){if(i!=e.model.id)return!1;e.basket.model=_.without(e.basket.model,i),e.basket.model=_.without(e.basket.model,""+i),e.removeFromBasket()}),this.basket.subscribe("add:byid",function(i){if(i!=e.model.id)return!1;e.addToBasket()}),this.$el.find(".search-exam").children(".exam-con").on("click",function(i){e.visibled_analyticbox=!e.visibled_analyticbox,e.show_analyticbox()}),this.basket.subscribe("show-analyticbox",function(i){e.visibled_analyticbox=i,e.show_analyticbox()})}},a}();