var _util=OT2.Util,Field=OT2.Field;OT2.UserForm=function(){var t=function(){this.errors=[],this.checkFields=[]};t.prototype={checkForm:function(){this.errors=[];for(var t,e=0;t=this.checkFields[e++];){var i=t.checkIt();i&&this.errors.push(i)}return!this.errors.length},addField:function(t){this.checkFields.push(t)},initCheckField:function(){},bindOnFocus:function(){for(var t,e=0;t=this.checkFields[e++];)t.addRule("focus",function(){this.removeError()},!1)},bindEvent:function(){},init:function(){return this.initCheckField(),this.bindOnFocus(),this.bindEvent(),this}};var e=function(){if(!(this instanceof e))return new e;this.$form=$("#login-form"),this.returnurl=null,t.call(this)};_.extend(e.prototype,t.prototype),_.extend(e.prototype,{initCheckField:function(){var t=new Field("#account");t.addRule("blur",function(t){if(t.length<=0)return"账号不能为空！"}),this.addField(t),(t=new Field("#password")).addRule("blur",function(t){if(t.length<=0)return"密码不能为空！"}),this.addField(t)},clearError:function(){for(var t,e=0;t=this.checkFields[e++];)t.removeError()},bindEvent:function(){var t=this;this.ajaxLoginStatus=!1,this.$form.on("submit",function(){if(t.ajaxLoginStatus)return!1;t.ajaxLoginStatus=!0;return t.checkForm()&&(t.$form.find("button[type=submit]").html("登录中..."),t.ajaxLogin().always(function(){t.ajaxLoginStatus=!1,t.$form.find("button[type=submit]").html("登录")})),!1})},ajaxLogin:function(){var t=this,e=this.$form.serializeArray();return $.post("/login",e,function(e){if(0==e.errCode){if("function"==typeof t.subscribe_login_success)return t.subscribe_login_success(t),!1;if(t.returnurl)return window.location.href=t.returnurl,!1;window.location.href=window.location.href}else t.checkFields[1].showError(e.message)},"json")}});var i=function(t){_Field=new Field("#password");var e=_Field;_Field.addRule("blur",function(t){if(t.length<=0)return"请输入密码！";if(t.length<6)return"请输入最少6位的登录密码！";var n=i.getVal();if(n&&n!=t)return"确认密码输入不一致！";n&&n==t&&(i.removeError(),e.removeError())}),t.addField(_Field),_Field=new Field("#password_confirm");var i=_Field;_Field.addRule("blur",function(t){if(t.length<=0)return"请输入确认密码！";if(t.length<6)return"请输入最少6位的登录密码！";var n=e.getVal();if(n&&n!=t)return"确认密码输入不一致！";n&&n==t&&(i.removeError(),e.removeError())}),t.addField(_Field)},n=function(){if(!(this instanceof n))return new n;this.$form=$("#J_RegisterFormByMobile"),t.call(this)};_.extend(n.prototype,t.prototype),_.extend(n.prototype,{initCheckField:function(){var t=new Field("#mobile");this.mobileField=t,t.addRule("blur validate",function(t){if(t.length<=0)return"请输入手机号码！";if(!/^(13[0-9]|15[0-9]|18[0-9]|14[57])\d{8}$/.test(t))return"手机格式不正确！";return this.$el.data("res")==t?"该手机号码已经被注册过！":void 0}),this.addField(t),(t=new Field("#captcha_code")).addRule("blur",function(t){return t.length<=0?"请输入验证码！":/^\d{4}$/.test(t)?void 0:"请输入4位验证码！"}),this.addField(t),i(this)},bindEvent:function(){var t=this;$("#J_getCode").on("click",function(e){if(t.mobileField.checkIt())return!1;OT2.Util.getCode(this)}),this.$form.on("submit",function(){return!!t.checkForm()})}});var r=function(){if(!(this instanceof r))return new r;this.$form=$("#J_RegisterFormByEmail"),t.call(this)};_.extend(r.prototype,t.prototype),_.extend(r.prototype,{initCheckField:function(){var t=new Field("#email");t.addRule("blur",function(t){return t.length<=0?"请输入邮箱！":/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/.test(t)?void 0:"邮箱格式不对！"}),this.addField(t),i(this);var e=this;$("#submit_mail").bind("click",function(){if(!e.checkForm())return!1;var t=$("#email").val(),i=$("#password").val(),n="";$.post("/site/send-email",{email:t,password:i},"json").done(function(e){!function(t){dialog({title:"提示",content:_.template(OT2.Util.Template().get("send-email"),{content:t}),okValue:"确定",cancelValue:"关闭",ok:function(){},cancel:function(){}}).showModal()}(n=0==e.errCode?'<h1>验证邮箱发送成功</h1><p>请进入邮箱 <a href="'+e.message+'" target="_blank">'+t+"</a> 点击链接激活邮箱</p>":e.message)}).fail()})}});var o=function(){if(!(this instanceof o))return new o;this.$form=$("#J_RegisterFormByMobile"),t.call(this)};_.extend(o.prototype,t.prototype),_.extend(o.prototype,{initCheckField:function(){!function(t){var e=new Field("#mobile");e.addRule("blur",function(t){return t.length<=0?"请输入手机号码！":/^(13[0-9]|15[0-9]|18[0-9]|14[57])\d{8}$/.test(t)?void 0:"手机格式不正确！"}),e.addRule("validate",function(t){if(this.$el.data("res")==t)return"该手机号码已经被注册过！"}),t.addField(e),(e=new Field("#captcha_code")).addRule("blur",function(t){return t.length<=0?"请输入验证码！":/^\d{4}$/.test(t)?void 0:"请输入4位验证码！"}),t.addField(e)}(this)},bindEvent:function(){var t=this;this.$form.on("submit",function(){return!!t.checkForm()||(alert(t.errors),!1)})}});var l=function(){if(!(this instanceof l))return new l;this.$form=$("#J_RegisterFormByMobile"),t.call(this)};_.extend(l.prototype,t.prototype),_.extend(l.prototype,{initCheckField:function(){i(this)},bindEvent:function(){var t=this;this.$form.on("submit",function(){return!!t.checkForm()})}});var s=function(){if(!(this instanceof s))return new s;this.$form=$("#J_RegisterFormByEmail"),t.call(this)};_.extend(s.prototype,t.prototype),_.extend(s.prototype,{initCheckField:function(){!function(t){var e=new Field("#account");e.addRule("blur",function(t){return t.length<=0?"请输入邮箱！":/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/.test(t)?void 0:"邮箱格式不对！"}),t.addField(e)}(this)},bindEvent:function(){var t=this;this.$form.on("submit",function(){return!!t.checkForm()})}});var u=function(){if(!(this instanceof u))return new u;this.$form=$("#J_RegisterFormByEmail"),t.call(this)};return _.extend(u.prototype,t.prototype),_.extend(u.prototype,{initCheckField:function(){i(this)},bindEvent:function(){var t=this;this.$form.on("submit",function(){return!!t.checkForm()})}}),{initPlaceholder:function(){void 0===document.createElement("input").placeholder&&$(".placeholder").each(function(){var t=$(this);t.show(),t.next("input").on("keyup focus",function(){var e=$.trim(this.value);t[e?"hide":"show"]()}).on("blur",function(){$.trim(this.value)||t.show()}).trigger("keyup")})},Login:e,MobileRegister:n,EmailRegister:r,GetPasswordByMobileStep1:o,GetPasswordByMobileStep2:l,GetPasswordByEmailStep1:s,GetPasswordByEmailStep3:u}}();